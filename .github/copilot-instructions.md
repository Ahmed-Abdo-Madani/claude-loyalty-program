# Loyalty Program Platform – AI Coding Guide

## Architecture Overview

**Stack**: React 18 + Vite + Tailwind (port 3000) | Express + Sequelize + PostgreSQL (port 3001)  
**Mobile Wallets**: Apple PassKit (.pkpass files with PKCS7 signing) + Google Wallet Objects (JWT)  
**Security Model**: Secure public IDs only (biz_*, off_*, branch_*, cust_*) – **never expose integer IDs**

### Critical Design Decisions

- **Multi-tenancy**: All business data isolated by `business_id` (secure ID). Every API call validates business ownership.
- **Wallet Architecture**: Backend generates signed passes; frontend never touches certificates. Apple passes use real PKCS7 signatures with production certificates.
- **QR Flow**: Customers scan QR codes containing encrypted JWT tokens. Backend validates via `SecureQRService` and updates `CustomerProgress`.
- **Auto-Migrations**: Production deployments automatically run pending migrations on startup (disable with `AUTO_MIGRATE=false`).
- **I18n Architecture**: Full bilingual support (Arabic/English) with RTL layouts. Backend uses `languageMiddleware.js` + JSON locale files; frontend uses `react-i18next`.

---

## Development Workflows (Cross-Platform)

**Start full stack** (recommended):
```bash
# Windows PowerShell
.\start-dev.ps1  # Auto-kills ports 3000/3001, starts backend then frontend

# Linux/macOS or npm scripts (any platform)
npm run dev:full  # Uses concurrently to start both servers
```

**Individual servers**:
```bash
npm run backend:dev  # Backend only (port 3001)
npm run dev          # Frontend only (port 3000)
```

**Auto-migrations**: By default, backend runs pending migrations on startup. Control via:
```bash
AUTO_MIGRATE=false  # Disable auto-migrations (manual migration required)
MIGRATION_LOCK_TIMEOUT=30000  # Milliseconds to wait for migration lock
```

**Health checks**: `GET /health` – Must respond before app is considered running  
**Static files**: `/uploads` (persistent disk in production), `/static`  
**CORS**: Pre-configured for localhost, 192.168.8.114, ngrok (dev); madna.me domains (prod)

**Migration workflow** (see `backend/services/AutoMigrationRunner.js`):
```bash
# Check migration status
npm run migrate:status

# List pending migrations
npm run migrate:pending

# Run all pending migrations manually
npm run migrate:all

# Run specific migration
node backend/migrations/YYYYMMDD-migration-name.js
```

---

## Authentication & Multi-Tenancy (CRITICAL)

### Business API Calls

**Every request** to `/api/business/*` **must** include:
```js
headers: {
  'x-session-token': sessionToken,  // From login response
  'x-business-id': businessId       // Secure ID (biz_*)
}
```

**Frontend helpers** (use these exclusively):
```js
import { endpoints, secureApi } from '@/config/api'
import { getSecureAuthHeaders, secureApiRequest } from '@/utils/secureAuth'

// Automatic headers
await secureApi.post(endpoints.offers, { title: '9+1 Coffee', stamps_required: 10 })

// Manual headers
const headers = getSecureAuthHeaders()
```

**Backend validation**: Routes use middleware to extract/validate `x-business-id` and ensure queries filter by it.

---

## Database Layer (Sequelize)

### Models & Associations

**Location**: `backend/models/*`  
**Key models**: Business, Offer, Branch, Customer, CustomerProgress, WalletPass, OfferCardDesign, Device, DeviceRegistration

**Association pattern** (ALL foreign keys use `public_id`):
```js
Business.hasMany(Offer, {
  foreignKey: 'business_id',
  sourceKey: 'public_id',  // ← Secure ID, not integer id
  as: 'offers'
})

Offer.belongsTo(Business, {
  foreignKey: 'business_id',
  targetKey: 'public_id'  // ← Secure ID
})
```

**Security critical**: Never query by integer `id`. Always use secure public IDs (`biz_*`, `off_*`, etc.) generated by `SecureIDGenerator`.

### Field Naming Convention

| Database Column       | Model Property        | API/DTO Property       |
|-----------------------|-----------------------|------------------------|
| `current_stamps`      | `current_stamps`      | `stampsEarned`         |
| `max_stamps`          | `max_stamps`          | `stampsRequired`       |
| `is_completed`        | `is_completed`        | `status`               |
| `authentication_token`| `authentication_token`| (sensitive, redacted)  |

**Always map** DB fields → DTO fields when returning API responses.

### Migrations

**Auto-migration system** (`AutoMigrationRunner.js`):
- Runs on server startup (unless `AUTO_MIGRATE=false`)
- Uses advisory locks to prevent concurrent execution
- Tracks executed migrations in `schema_migrations` table
- Validates checksums for integrity

**Migration file structure**:
```js
// backend/migrations/YYYYMMDD-description.js
export async function up(queryInterface, Sequelize) {
  // Migration logic
}

export async function down(queryInterface, Sequelize) {
  // Rollback logic
}

// CRITICAL: Must close connection before exit
import sequelize from '../config/database.js'
await sequelize.close()
process.exit(0)
```

**Manual execution**:
```bash
# SQL migrations - Run in pgAdmin Query Tool
# backend/migrations/*.sql

# JS migrations - Run via Node.js
node backend/migrations/20250127-add-branch-manager-auth.js
```

**Common pitfall**: Migrations that hang after "Database pool initialized" are missing `await sequelize.close()` before `process.exit()`.

---

## Internationalization (i18n) Architecture

### Backend i18n

**Language detection** (`languageMiddleware.js`):
```js
// Extracts language from Accept-Language header or ?lang= query param
// Attaches req.locale = 'ar' | 'en' to all requests
app.use(extractLanguage)
```

**Message retrieval**:
```js
import { getLocalizedMessage } from './middleware/languageMiddleware.js'

// Locale files: backend/locales/{ar,en}/messages.json
const message = getLocalizedMessage('appleWallet.fields.progress', req.locale || 'ar', { count: 5 })
```

**Message files structure**:
```json
// backend/locales/ar/messages.json
{
  "appleWallet": {
    "fields": {
      "progress": "التقدم: {{count}}/{{total}}"
    }
  }
}
```

### Frontend i18n

**React implementation** (`react-i18next`):
```js
import { useTranslation } from 'react-i18next'

function Component() {
  const { t, i18n } = useTranslation('dashboard')  // Namespace
  
  return (
    <div dir={i18n.dir()}>  {/* Auto RTL/LTR */}
      <h1>{t('title')}</h1>
      <p>{t('welcome', { name: userName })}</p>
    </div>
  )
}
```

**Translation files**: `src/locales/{ar,en}/{namespace}.json`

**Language switching**:
```js
// Components include language in API headers
const headers = {
  'Accept-Language': i18n.language || 'ar',
  ...getSecureAuthHeaders()
}
```

**RTL layout**: 
- Global `dir` attribute set by i18next
- Tailwind uses `rtl:` prefix for RTL-specific styles
- Replace `space-x-*` with `gap-*` for bidirectional spacing

---

## Apple Wallet Integration (Production)

### Certificate Infrastructure

**Certificates loaded on startup** by `appleCertificateValidator.js`:
- Pass Type ID Certificate (.p12) – Signs manifests
- WWDR Certificate (.pem) – Completes certificate chain
- **Location**: `backend/certificates/` (git-ignored)

**Pass Generation Flow**:
1. `appleWalletController.generatePass()` creates `pass.json` with real Pass Type ID (`pass.me.madna.api`)
2. Generates images (logo, strip/hero) with Sharp
3. Creates manifest with SHA-1 hashes of all files
4. `applePassSigner.signManifest()` creates PKCS7 detached signature
5. Packages .pkpass ZIP with pass.json, manifest.json, signature, images
6. Records in DB via `WalletPassService.createWalletPass()` with auth token + ETag

### Authentication Token Algorithm (MUST MATCH)

**Controller & Model must use identical algorithm**:
```js
// backend/controllers/appleWalletController.js
generateAuthToken(customerId, offerId) {
  const data = `${customerId}:${offerId}:${Date.now()}`
  return crypto.createHash('sha256').update(data).digest('hex').substring(0, 32)
}

// backend/models/WalletPass.js
WalletPass.generateAuthToken = function(customerId, offerId) {
  const data = `${customerId}:${offerId}:${Date.now()}`
  return crypto.createHash('sha256').update(data).digest('hex').substring(0, 32)
}
```

**Critical**: Use `offerId` (not `serialNumber`). Store token in `wallet_passes.authentication_token`.

### Apple Web Service Protocol

**Routes**: `backend/routes/appleWebService.js` mounted at `/api/apple`  
**Endpoints**:
- `POST /v1/devices/:deviceLibraryId/registrations/:passTypeId/:serialNumber` – Device registration
- `GET /v1/devices/:deviceLibraryId/registrations/:passTypeId` – Get updatable passes
- `GET /v1/passes/:passTypeId/:serialNumber` – Download updated pass (with ETag caching)
- `POST /v1/log` – Device error logs (stored in `DeviceLog` model)

**ETag Caching** (manifest_etag):
- Computed from manifest SHA-256 hash: `computeManifestETag(manifest)`
- Stored in `wallet_passes.manifest_etag`
- Compared with `If-None-Match` header → Return 304 Not Modified if match
- **Reduces bandwidth by 15-30%**

---

## Logging & Security (Production)

### Sensitive Data Redaction

**Logger** (`backend/config/logger.js`) **auto-redacts** in production:
- `authenticationToken` → `abcdef12...[REDACTED]`
- `serialNumber` → `cust_abc...[REDACTED]`
- `push_token`, `device_id`, ETags

**Usage**:
```js
import logger from './config/logger.js'

// Auto-redacted in production
logger.safe.info('Pass generated', { authenticationToken, serialNumber })

// Debug-only logs (hidden in production)
logger.debug('Full pass.json:', passData)
if (logger.isDebugMode()) {
  logger.info('Detailed manifest:', manifest)
}
```

**Environment control**:
- `NODE_ENV=production` → info level, full redaction
- `NODE_ENV=development` → debug level, no redaction
- `LOG_LEVEL=debug` → Verbose logs with redaction

---

## Storage & Static Assets

### Persistent Uploads (CRITICAL)

**Problem**: Container redeploys wipe `/uploads` → 404s on logos/images  
**Solution**: Use `UPLOADS_DIR` and `UPLOADS_BASE_URL` env vars

**Configuration** (Render persistent disk):
```bash
UPLOADS_DIR=/opt/render/project/src/backend/uploads
UPLOADS_BASE_URL=https://api.madna.me/uploads
```

**Implementation**:
```js
// backend/services/ImageProcessingService.js
const uploadDir = process.env.UPLOADS_DIR || path.join(process.cwd(), 'uploads')
const baseUrl = process.env.UPLOADS_BASE_URL || process.env.BASE_URL

// URL generation (avoid double /uploads)
const url = process.env.UPLOADS_BASE_URL 
  ? `/designs/processed/${filename}`  // WITH UPLOADS_BASE_URL
  : `/uploads/designs/processed/${filename}`  // Without (dev)
```

**Server.js**:
```js
const uploadsDir = process.env.UPLOADS_DIR || path.join(__dirname, 'uploads')
app.use('/uploads', express.static(uploadsDir))
```

---

## QR Scanning Flow

**Frontend** (`src/components/EnhancedQRScanner.jsx`):
- Scans URL: `https://.../scan/{customerToken}/{offerHash}`
- Scans Google Wallet JSON: `{ customerId, offerId, businessId }`
- Computes `offerHash = MD5(${offerId}:${businessId}:loyalty-platform)`
- Calls `onScanSuccess(token, offerHash, raw)`

**Backend** (`backend/routes/business.js` → `/api/business/scan/verify`):
- Validates `customerToken` (JWT via `SecureQRService.validateCustomerQR()`)
- Verifies `offerHash` matches expected hash
- Updates `CustomerProgress.current_stamps`
- Triggers Apple/Google Wallet push notifications

**QR Token Generation** (`SecureQRService`):
```js
// Generate encrypted JWT token for customer QR codes
const token = SecureQRService.generateCustomerQR(customerId, businessId, offerId)
// Returns: JWT with { type: 'customer_scan', cid, bid, oid }

// Validate any QR token
const result = SecureQRService.validateAnyQRToken(token)
// Returns: { isValid, type, customerId, businessId, offerId }
```

**Critical**: QR tokens use separate `QR_JWT_SECRET` (min 64 chars in production) for enhanced security.

---

## Google Wallet Integration

### Architecture

**Controller**: `backend/controllers/realGoogleWalletController.js` (singleton export)  
**Service Account**: Credentials from env vars or `credentials/madna-platform-*.json`  
**Issuer ID**: `3388000000023017940` (production)

**Pass generation flow**:
1. Authenticate via Google Cloud service account (`GoogleAuth`)
2. Create/update loyalty class (offer template) via Wallet Objects API
3. Create loyalty object (customer-specific instance)
4. Sign JWT with service account private key
5. Return save URL: `https://pay.google.com/gp/v/save/{jwt}`
6. Record in `WalletPass` model with `wallet_type='google'`

**JWT structure**:
```js
const claims = {
  iss: serviceAccountEmail,
  aud: 'google',
  typ: 'savetowallet',
  iat: Math.floor(Date.now() / 1000),
  exp: iat + 3600,
  payload: {
    loyaltyObjects: [loyaltyObject]
  }
}
const jwt = jwt.sign(claims, privateKey, { algorithm: 'RS256' })
```

**Push notifications** (`pushProgressUpdate()`):
```js
// Update existing loyalty object in Google Wallet
await googleWalletController.updateLoyaltyObject(objectId, {
  loyaltyPoints: { balance: { string: `${current}/${required}` } }
})
```

**Critical fields**:
- `wallet_object_id`: Google's object ID (stored in `wallet_passes`)
- `last_updated_tag`: Apple-specific, **must be nullable** for Google passes
- Object ID format: `${issuerId}.${customerId}_${offerId}` (sanitize special chars)

---

## Common Pitfalls & Fixes

### 1. Auth Token Mismatch (401 errors)
**Symptom**: Devices can't register/fetch passes  
**Cause**: Controller generates token with wrong data (serialNumber instead of offerId)  
**Fix**: Ensure `generateAuthToken(customerId, offerId)` everywhere. Never mutate token on GET.

### 2. stampsEarned: undefined
**Cause**: DB uses `current_stamps`, API expects `stampsEarned`  
**Fix**: Map on return: `stampsEarned: progress.current_stamps || 0`

### 3. manifest_etag missing
**Cause**: Column doesn't exist (migration not run)  
**Fix**: Run `backend/migrations/20250122-add-manifest-etag-to-wallet-passes.sql` in pgAdmin

### 4. Upload files disappear after deploy
**Cause**: Ephemeral container filesystem  
**Fix**: Set `UPLOADS_DIR` + `UPLOADS_BASE_URL` with persistent disk mount

### 5. Google Wallet pass generation fails with NULL constraint
**Symptom**: `null value in column "last_updated_tag" violates not-null constraint`  
**Cause**: Column is Apple-specific but marked NOT NULL  
**Fix**: Run `node backend/migrations/20250125-fix-last-updated-tag-nullable.js`

### 6. Migration hangs after "Database pool initialized"
**Cause**: Missing `await sequelize.close()` before `process.exit(0)`  
**Fix**: Add connection cleanup at end of migration file

---

## Service Layer Patterns

### Key Services

**WalletPassService** (`backend/services/WalletPassService.js`):
- CRUD operations for `WalletPass` model
- Handles both Apple and Google pass records
- **Critical**: Use platform-specific fields (Apple: `authentication_token`, Google: `wallet_object_id`)

**SecureQRService** (`backend/services/SecureQRService.js`):
- JWT-based QR token generation/validation
- Supports multiple token types: `customer_scan`, `offer_signup`, `business_scanner`
- Uses separate `QR_JWT_SECRET` for enhanced security

**AutoMigrationRunner** (`backend/services/AutoMigrationRunner.js`):
- Automatic migration execution on startup
- Advisory locks prevent concurrent runs
- Checksum validation ensures integrity
- Methods: `runPendingMigrations()`, `getMigrationStatus()`, `validateMigrationIntegrity()`

**ImageProcessingService** (`backend/services/ImageProcessingService.js`):
- Logo upload and processing for wallet passes
- Generates multiple sizes (1x, 2x, 3x for Apple; optimized for Google)
- Returns **absolute URLs** for card design logos (not relative paths)

**ApnsService** (`backend/services/ApnsService.js`):
- Apple Push Notification Service for wallet updates
- Requires APN certificates in `backend/certificates/`
- Sends push to registered devices when pass updates

### Controller Patterns

**Singleton exports**:
```js
// backend/controllers/appleWalletController.js
class AppleWalletController { /* ... */ }
export default new AppleWalletController()  // ← Singleton instance
```

**Class exports** (static methods):
```js
// backend/controllers/locationController.js
class LocationController { /* ... */ }
export default LocationController  // ← Class itself (use static methods)
```

---

## Testing & Verification

**Backend health check**:
```bash
curl http://localhost:3001/health
# Expected: 200 OK with { status: 'ok' }
```

**Migration verification**:
```bash
# Check migration status
npm run migrate:status

# Validate integrity
npm run migrate:validate
```

**Apple Wallet pass generation** (local):
```bash
curl -X POST http://localhost:3001/api/wallet/apple/generate \
  -H "Content-Type: application/json" \
  -d '{"customerId":"cust_123","offerId":"off_456","businessId":"biz_789"}'
```

**Frontend i18n testing**:
- Toggle language switcher (globe icon) → Interface should switch immediately
- Check localStorage: `localStorage.getItem('i18nextLng')` → 'ar' or 'en'
- Navigate between pages → Language should persist
- RTL test: Arabic text aligns right, icons flip (e.g., chevrons)

**Secure API testing**:
```js
import { endpoints, secureApi } from '@/config/api'

// Automatic auth headers (session token + business ID)
const response = await secureApi.get(endpoints.myOffers)
console.log(response.data)
```

---

## Key Files Reference

**Backend Core**:
- `backend/server.js` – Entry point, route mounting, global error handlers
- `backend/models/index.js` – Model associations (all use `public_id`)
- `backend/config/logger.js` – Winston logger with sensitive data redaction

**Apple Wallet**:
- `backend/controllers/appleWalletController.js` – Pass generation, signing, ETag
- `backend/routes/appleWebService.js` – Web Service Protocol endpoints
- `backend/utils/applePassSigner.js` – PKCS7 signature generation
- `backend/utils/appleCertificateValidator.js` – Certificate loading/validation
- `backend/models/WalletPass.js` – Pass storage, auth token methods

**Frontend API**:
- `src/config/api.js` – Centralized endpoints + secureApi wrapper
- `src/utils/secureAuth.js` – Auth headers, localStorage, logout
- `src/components/EnhancedQRScanner.jsx` – QR scanning + format handling
