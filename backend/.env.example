# ========================================
# MADNA LOYALTY PLATFORM - ENVIRONMENT VARIABLES
# ========================================
# This file documents all environment variables used in production.
# Copy this file to .env for local development and fill in your values.
# NEVER commit actual secrets to version control!
# ========================================

# ----------------------------------------
# Node Environment
# ----------------------------------------
NODE_ENV=development
# Production: NODE_ENV=production

# ----------------------------------------
# Server Configuration
# ----------------------------------------
PORT=3001
BASE_URL=http://localhost:3001
# Production: BASE_URL=https://api.madna.me

FRONTEND_URL=http://localhost:3000
# Production: FRONTEND_URL=https://app.madna.me

# ----------------------------------------
# Database Configuration
# ----------------------------------------
# Use DATABASE_URL for PostgreSQL connection (recommended for Render/Heroku)
DATABASE_URL=postgresql://username:password@localhost:5432/loyalty_platform
# Production format: postgresql://user:pass@host/database
# Example: postgresql://madna_admin:password@dpg-xxxxx-a/madna_loyalty_platform

# ----------------------------------------
# Security - JWT & Session Secrets
# ----------------------------------------
# ⚠️ CRITICAL: Generate strong secrets for production!
# Generate with: openssl rand -base64 32 (for JWT_SECRET)
# Generate with: openssl rand -base64 64 (for SESSION_SECRET)

JWT_SECRET=dev-jwt-secret-change-in-production-min-32-chars
# Production example: 9c?Nj-T{2-gtaeY17TkkR064hX87MQ$p)W5wxpgru+CTU,rMY76HSr#RMH@m,[LA
# Minimum length: 32 characters
# Used for admin/branch manager authentication tokens

SESSION_SECRET=dev-session-secret-change-in-production-min-64-chars
# Production example: [3*:SE*N)U1_ZEP1vCTg{G=Dy#jk)+kCjwp.vE}&/{?.Zbh(FM9Sejr)7q])6:%$
# Used for session cookie signing

ENCRYPTION_KEY=dev-encryption-key-change-in-production-32-chars
# Production example: -$bWq!k)8z{$uxNMxdhS5-ze[-T7D4E@
# Used for encrypting sensitive data in database

# ----------------------------------------
# QR Code Security
# ----------------------------------------
QR_JWT_SECRET=dev-qr-jwt-secret-change-in-production-min-64-chars
# Generate with: openssl rand -base64 64
# CRITICAL: This secret signs QR codes and must be persistent across restarts
# If changed, all existing QR codes will become invalid
# Production: Use a strong 64+ character secret

# ----------------------------------------
# Apple Wallet Configuration
# ----------------------------------------
APPLE_TEAM_ID=YOUR_TEAM_ID
# Production: NFQ6M7TFY2
# Find in Apple Developer Account > Membership

APPLE_PASS_TYPE_ID=pass.com.yourcompany.loyalty
# Production: pass.me.madna.api
# Must match the Pass Type ID registered in Apple Developer

# Apple Pass Certificate (P12 format)
# Development: Use file path
APPLE_PASS_CERTIFICATE_PATH=./certificates/pass.p12
APPLE_PASS_CERTIFICATE_PASSWORD=your_p12_password
# Production: Watashi12Des

# Production: Use base64-encoded certificate (recommended for Render/Heroku)
# APPLE_PASS_CERTIFICATE_BASE64=MIIM9wIBAzCCDKUGCSqGSIb3DQEHAa...
# Alternative names also supported:
# APPLE_CERT_P12_BASE64=...
# Generate with: base64 -i certificates/pass.p12 | tr -d '\n'

# Apple WWDR Certificate (PEM format)
APPLE_WWDR_CERTIFICATE_PATH=./certificates/AppleWWDRCAG4.pem
# Production: Use base64-encoded certificate
# APPLE_CERT_WWDR_BASE64=LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0t...
# Generate with: base64 -i certificates/AppleWWDRCAG4.pem | tr -d '\n'

# ----------------------------------------
# Apple Push Notification Service (APNs)
# ----------------------------------------
# CRITICAL: APNs uses the SAME certificate as Apple Wallet pass signing
# The Pass Type ID certificate (.p12) serves dual purpose:
#   1. Signing pass manifests (PKCS7 signatures)
#   2. Sending APNs push notifications to update passes
#
# APNS_TOPIC MUST equal APPLE_PASS_TYPE_ID (required by Apple's spec)
APNS_TOPIC=pass.me.madna.api
# Production: pass.me.madna.api (MUST match APPLE_PASS_TYPE_ID exactly)

# APNs requires production environment for Wallet passes (sandbox doesn't work)
APNS_PRODUCTION=true
# Production: true (REQUIRED - sandbox doesn't support Wallet pass updates)

# Certificate Configuration (multiple supported env var names for flexibility)
# Option 1: Base64-encoded certificate (RECOMMENDED for production)
APPLE_PASS_CERTIFICATE_BASE64=<base64-encoded-p12-file>
# Alternatives: APPLE_APNS_CERT_BASE64 or APNS_CERT_BASE64
# Production: Use same certificate as pass signing

# Certificate password (multiple supported names)
APPLE_PASS_CERTIFICATE_PASSWORD=Watashi12Des
# Alternatives: APNS_CERT_PASSWORD or APPLE_APNS_CERT_PASSWORD

# Option 2: File path (for local development only)
# APNS_CERT_PATH=./certificates/pass-cert.p12
# Alternatives: APPLE_APNS_CERT_PATH or APPLE_PASS_CERTIFICATE_PATH

# Production Configuration Example:
# APNS_TOPIC=pass.me.madna.api
# APNS_PRODUCTION=true
# APPLE_PASS_CERTIFICATE_BASE64=<base64-p12-content>
# APPLE_PASS_CERTIFICATE_PASSWORD=Watashi12Des
#
# Note: This reuses the existing Pass Type ID certificate - no separate APNs cert needed!
# Documentation: docs/APPLE-APNS-CERTIFICATE-SETUP.md


# ----------------------------------------
# Google Wallet Configuration
# ----------------------------------------
GOOGLE_PROJECT_ID=your-google-project-id
# Production: madna-platform

GOOGLE_ISSUER_ID=3388000000000000000
# Production: 3388000000023017940
# Find in Google Pay & Wallet Console

GOOGLE_SERVICE_ACCOUNT_EMAIL=your-service-account@your-project.iam.gserviceaccount.com
# Production: platform-admin@madna-platform.iam.gserviceaccount.com

# Google Service Account Private Key
GOOGLE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\nYOUR_PRIVATE_KEY_HERE\n-----END PRIVATE KEY-----\n"
# Production: Set via environment variable (multi-line string)
# Escape newlines as \n in the key

# Google Application Credentials (JSON file path)
GOOGLE_APPLICATION_CREDENTIALS=./certificates/google-service-account.json
# Production: /etc/secrets/madna-platform-d8bf716cd142.json
# For Render: Upload as secret file

# ----------------------------------------
# File Upload Configuration
# ----------------------------------------
UPLOADS_DIR=./uploads
# Production: /app/uploads
# Must be a persistent disk mount in production (Render persistent disk)

UPLOADS_BASE_URL=http://localhost:3001/uploads
# Production: https://api.madna.me/uploads
# Public URL for accessing uploaded files

ICONS_PATH=./uploads/icons/stamps
# Production: /app/uploads/icons/stamps
# Path for stamp icons used in loyalty cards

# ----------------------------------------
# Auto-Engagement Configuration
# ----------------------------------------
DISABLE_AUTO_ENGAGEMENT=false
# Set to 'true' to disable the daily auto-engagement cron job
# Useful for testing or temporary disabling

PASS_INACTIVITY_EXPIRATION_DAYS=90
# Days of inactivity before expiring completed passes
# Default: 90 days

# ----------------------------------------
# Notification Limits
# ----------------------------------------
WALLET_NOTIFICATION_DAILY_LIMIT=10
# Maximum wallet notifications per customer per day
# Prevents notification spam

# ----------------------------------------
# Schema Validation (Advanced)
# ----------------------------------------
# SKIP_SCHEMA_VALIDATION=false
# Set to 'true' to skip startup schema checks (emergency bypass only)
# Not recommended for production

# SKIP_SCHEMA_CHECKS=false
# Alternative name for SKIP_SCHEMA_VALIDATION

# ----------------------------------------
# Automatic Migration Configuration
# ----------------------------------------
AUTO_MIGRATE=true
# Set to 'false' to disable automatic migrations on startup
# Default: true in production, recommended to keep enabled
# When enabled, pending migrations run automatically before server starts
# When disabled, migrations must be run manually before deployment

MIGRATION_LOCK_TIMEOUT=30000
# Milliseconds to wait for migration advisory lock
# Default: 30000 (30 seconds)
# Increase if migrations take longer or deployments are slow

MIGRATION_STOP_ON_ERROR=true
# Stop migration execution on first error
# Default: true (recommended for production)
# Set to 'false' to continue running migrations even if one fails (not recommended)

# ========================================
# AUTOMATIC MIGRATION SYSTEM
# ========================================
# The platform now includes automatic migration tracking and execution.
# Migrations run automatically in two places:
#
# 1. Render preDeploy Command (Primary)
#    - Runs: node scripts/deploy-migrations.js
#    - When: After build, before traffic switches to new version
#    - Benefit: Zero-downtime deployments
#    - Requires: Render Starter plan or higher
#
# 2. Server Startup (Safety Net)
#    - Runs: AutoMigrationRunner.runPendingMigrations()
#    - When: During server initialization
#    - Benefit: Catches missed migrations, validates schema
#    - Controlled by: AUTO_MIGRATE environment variable
#
# Migration Tracking:
#    - Table: schema_migrations
#    - Tracks: Applied migrations, execution time, status, checksums
#    - Prevents: Duplicate execution, concurrent runs (advisory locks)
#
# Manual Migration (Emergency):
#    - Disable auto-migrations: AUTO_MIGRATE=false
#    - Run manually: npm run migrate:auto
#    - Check status: npm run migrate:status
#    - List pending: npm run migrate:pending
# ========================================

# ========================================
# PRODUCTION DEPLOYMENT CHECKLIST
# ========================================
# Before deploying to production:
# ✅ Generate strong JWT_SECRET (min 32 chars)
# ✅ Generate strong SESSION_SECRET (min 64 chars)
# ✅ Generate strong ENCRYPTION_KEY (32 chars)
# ✅ Generate strong QR_JWT_SECRET (min 64 chars)
# ✅ Set NODE_ENV=production
# ✅ Set APNS_PRODUCTION=true
# ✅ Upload Apple certificates as base64 env vars
# ✅ Upload Google service account JSON as secret file
# ✅ Configure persistent disk for UPLOADS_DIR
# ✅ Set correct BASE_URL and FRONTEND_URL
# ✅ Verify DATABASE_URL connection string
# ✅ AUTO_MIGRATE=true (enabled for automatic migrations)
# ✅ schema_migrations table created
# ✅ All pending migrations applied
# ========================================